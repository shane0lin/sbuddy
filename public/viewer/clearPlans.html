<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Study Plans</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .plan-list {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .plan-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 600;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Study Plan Manager</h1>
        <p>Manage your study plans and clear duplicates.</p>

        <div id="planList" class="plan-list">
            <!-- Plans will be loaded here -->
        </div>

        <div id="message"></div>

        <div style="margin-top: 20px;">
            <button class="btn-danger" onclick="clearAllPlans()">Clear ALL Plans</button>
            <button class="btn-primary" onclick="removeDuplicates()">Remove Duplicate "My Study Plan"</button>
            <button class="btn-success" onclick="location.reload()">Refresh</button>
        </div>

        <div style="margin-top: 20px;">
            <a href="index.html" style="color: #667eea;">‚Üê Back to Viewer</a>
        </div>
    </div>

    <script src="studyPlan.js"></script>
    <script>
        function loadPlans() {
            const plans = window.studyPlanManager.getPlans();
            const activePlanId = window.studyPlanManager.getActivePlanId();
            const planList = document.getElementById('planList');

            if (Object.keys(plans).length === 0) {
                planList.innerHTML = '<div class="info message">No study plans found.</div>';
                return;
            }

            let html = '<h3>Current Plans:</h3>';
            Object.values(plans).forEach(plan => {
                const isActive = plan.id === activePlanId;
                html += `
                    <div class="plan-item">
                        <div>
                            <strong>${plan.name}</strong> ${isActive ? '(Active)' : ''}
                            <br>
                            <small>ID: ${plan.id} | Problems: ${plan.problems.length}</small>
                        </div>
                        <button class="btn-danger" onclick="deleteSinglePlan('${plan.id}')">Delete</button>
                    </div>
                `;
            });

            planList.innerHTML = html;
        }

        function clearAllPlans() {
            if (confirm('Are you sure you want to delete ALL study plans? This cannot be undone!')) {
                localStorage.removeItem('amc_study_plans');
                localStorage.removeItem('amc_active_plan');
                showMessage('All study plans have been cleared!', 'success');
                loadPlans();
            }
        }

        function removeDuplicates() {
            const plans = window.studyPlanManager.getPlans();
            const plansByName = {};

            // Group plans by name
            Object.values(plans).forEach(plan => {
                if (!plansByName[plan.name]) {
                    plansByName[plan.name] = [];
                }
                plansByName[plan.name].push(plan);
            });

            // Find duplicates of "My Study Plan"
            const myStudyPlans = plansByName['My Study Plan'] || [];

            if (myStudyPlans.length <= 1) {
                showMessage('No duplicate "My Study Plan" found.', 'info');
                return;
            }

            // Keep the one with most problems, or the oldest one
            myStudyPlans.sort((a, b) => {
                if (b.problems.length !== a.problems.length) {
                    return b.problems.length - a.problems.length;
                }
                return new Date(a.createdAt) - new Date(b.createdAt);
            });

            const toKeep = myStudyPlans[0];
            const toDelete = myStudyPlans.slice(1);

            // Delete duplicates
            toDelete.forEach(plan => {
                delete plans[plan.id];
            });

            // Save updated plans
            window.studyPlanManager.savePlans(plans);

            // If we deleted the active plan, set the kept one as active
            const activePlanId = window.studyPlanManager.getActivePlanId();
            if (toDelete.some(p => p.id === activePlanId)) {
                window.studyPlanManager.setActivePlan(toKeep.id);
            }

            showMessage(`Removed ${toDelete.length} duplicate "My Study Plan" entries. Kept the one with ${toKeep.problems.length} problems.`, 'success');
            loadPlans();
        }

        function deleteSinglePlan(planId) {
            const plans = window.studyPlanManager.getPlans();
            const plan = plans[planId];

            if (confirm(`Delete plan "${plan.name}"?`)) {
                window.studyPlanManager.deletePlan(planId);
                showMessage(`Deleted plan "${plan.name}"`, 'success');
                loadPlans();
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // Load plans on page load
        loadPlans();
    </script>
</body>
</html>
